<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Elasticsearch笔记, pfcai-blog">
    <meta name="description" content="


es概念
数据库概念
说明



索引
数据库
ES中可以有多个索引库，就像Mysql中有多个Database一样。


类型
表
mysql中database可以有多个table，table用来约束数据结构。而ES中的每个索引库中只">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Elasticsearch笔记 | pfcai-blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">pfcai-blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">pfcai-blog</div>
        <div class="logo-desc">
            
            22届西部某211本科毕业即失业人员一枚
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/pfcai" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/pfcai" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Elasticsearch笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Elasticsearch/">
                                <span class="chip bg-color">Elasticsearch</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Elasticsearch/" class="post-category">
                                Elasticsearch
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-07-12
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-07-22
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    26 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <table>
<thead>
<tr>
<th align="center">es概念</th>
<th>数据库概念</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">索引</td>
<td>数据库</td>
<td align="left">ES中可以有多个索引库，就像Mysql中有多个Database一样。</td>
</tr>
<tr>
<td align="center">类型</td>
<td>表</td>
<td align="left">mysql中database可以有多个table，table用来约束数据结构。而ES中的每个索引库中只有一个类型，类型中用来约束字段属性的叫做映射(mapping)</td>
</tr>
<tr>
<td align="center">映射</td>
<td>表的字段约束</td>
<td align="left">mysql表对字段有约束，ES中叫做映射，用来约束字段属性，包括：字段名称、数据类型等信息</td>
</tr>
<tr>
<td align="center">文档</td>
<td>行</td>
<td align="left">存入索引库原始的数据，比如每一条商品信息，就是一个文档。对应mysql中的每行数据</td>
</tr>
<tr>
<td align="center">字段</td>
<td>列</td>
<td align="left">文档中的属性，一个文档可以有多个属性。就像mysql中一行数据可以有多个列。</td>
</tr>
</tbody></table>
<h1 id="1-ES的索引库操作"><a href="#1-ES的索引库操作" class="headerlink" title="1. ES的索引库操作"></a>1. ES的索引库操作</h1><p>按照Rest风格，增删改查分别使用：POST、DELETE、PUT、GET等请求方式，路径一般是资源名称。因此索引库操作的语法类似。</p>
<h2 id="1-1创建索引库"><a href="#1-1创建索引库" class="headerlink" title="1.1创建索引库"></a>1.1创建索引库</h2><p>创建索引库的请求格式：</p>
<ul>
<li>请求方式：PUT</li>
<li>请求路径：/索引库名</li>
<li>settings：就是索引库设置，其中可以定义索引库的各种属性，目前我们可以不设置，都走默认。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">put /索引库名
<span class="token punctuation">{</span>
    <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"属性名"</span><span class="token builtin class-name">:</span> <span class="token string">"属性值"</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-2查询索引库"><a href="#1-2查询索引库" class="headerlink" title="1.2查询索引库"></a>1.2查询索引库</h2><p>返回的信息是JSON格式，其中包含这么几个属性：</p>
<ul>
<li>mappings：类型映射，目前我们没有给索引库设置映射</li>
<li>settings：索引库配置，目前是默认配置</li>
</ul>
<h2 id="1-3总结"><a href="#1-3总结" class="headerlink" title="1.3总结"></a>1.3总结</h2><p>索引库操作：</p>
<ul>
<li>创建索引库： PUT /库名称</li>
<li>查询索引库： GET /索引库名称</li>
<li>删除索引库： DELETE /索引库名称</li>
</ul>
<h1 id="2-类型映射"><a href="#2-类型映射" class="headerlink" title="2. 类型映射"></a>2. 类型映射</h1><p>MySQL中有表，并且表中有对字段的约束，对应到elasticsearch中就是类型映射mapping.</p>
<h2 id="2-1-映射属性"><a href="#2-1-映射属性" class="headerlink" title="2.1 映射属性"></a>2.1 映射属性</h2><p>索引库数据类型是松散的，不过也需要我们指定具体的字段及字段约束信息。而约束字段信息的就叫做映射（mapping）。</p>
<h2 id="2-2-数据类型"><a href="#2-2-数据类型" class="headerlink" title="2.2 数据类型"></a>2.2 数据类型</h2><p>elasticsearch提供了非常丰富的数据类型：</p>
<p>比较常见的有：</p>
<p>string类型，又分两种：</p>
<p>text：可分词，存储到elasticsearch时会根据分词器分成多个词条</p>
<p>keyword：不可分词，数据会完整的作为一个词条</p>
<p>Numerical：数值类型，分两类</p>
<p>基本数据类型：long、interger、short、byte、double、float、half_float</p>
<p>浮点数的高精度类型：scaled_float</p>
<p>需要指定一个精度因子，比如10或100。elasticsearch会把真实值乘以这个因子后存储，取出时再还原。</p>
<p>Date：日期类型</p>
<p>Object：对象，对象不便于搜索。因此ES会把对象数据扁平化处理再存储。</p>
<h2 id="2-3-创建类型映射"><a href="#2-3-创建类型映射" class="headerlink" title="2.3 创建类型映射"></a>2.3 创建类型映射</h2><p>我们可以给一个已经存在的索引库添加映射关系，也可以创建索引库的同时直接指定映射关系。</p>
<h3 id="2-3-1-索引库已经存在"><a href="#2-3-1-索引库已经存在" class="headerlink" title="2.3.1 索引库已经存在"></a>2.3.1 索引库已经存在</h3><p>我们假设已经存在一个索引库，此时要给索引库添加映射。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PUT /索引库名/_mapping
<span class="token punctuation">{</span>
  <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"字段名1"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"类型"</span>,
      <span class="token string">"index"</span><span class="token builtin class-name">:</span> true，
      <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"分词器"</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"字段名2"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"类型"</span>,
      <span class="token string">"index"</span><span class="token builtin class-name">:</span> true，
      <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"分词器"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">..</span>.
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>类型名称：就是前面将的type的概念，类似于数据库中的表 字段名：任意填写，下面指定许多属性，例如：</p>
</li>
<li><ul>
<li>type：类型，可以是text、long、short、date、integer、object等</li>
<li>index：是否参与搜索，默认为true</li>
<li>analyzer：分词器</li>
</ul>
</li>
</ul>
<h3 id="2-3-2-索引库不存在"><a href="#2-3-2-索引库不存在" class="headerlink" title="2.3.2 索引库不存在"></a>2.3.2 索引库不存在</h3><p>如果一个索引库是不存在的，我们就不能用上面的语法，而是这样：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PUT /索引库名
<span class="token punctuation">{</span>
    <span class="token string">"mappings"</span>:<span class="token punctuation">{</span>
      <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"字段名1"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"类型"</span>,
          <span class="token string">"index"</span><span class="token builtin class-name">:</span> true，
          <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"分词器"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"字段名2"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"类型"</span>,
          <span class="token string">"index"</span><span class="token builtin class-name">:</span> true，
          <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"分词器"</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">..</span>.
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-4-查看映射关系"><a href="#2-4-查看映射关系" class="headerlink" title="2.4 查看映射关系"></a>2.4 查看映射关系</h2><p>查看使用Get请求</p>
<h1 id="3-Java操作ES"><a href="#3-Java操作ES" class="headerlink" title="3.Java操作ES"></a>3.Java操作ES</h1><h2 id="3-1-Java连接ES"><a href="#3-1-Java连接ES" class="headerlink" title="3.1 Java连接ES"></a>3.1 Java连接ES</h2><p>添加依赖</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token class-name">Elasticsearch</span>依赖<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>elasticsearch<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>elasticsearch<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.10</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token class-name">Elasticsearch</span> client依赖<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>elasticsearch<span class="token operator">-</span>rest<span class="token operator">-</span>high<span class="token operator">-</span>level<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.10</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>使用lombok简化开发<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>projectlombok<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>lombok<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token class-name">Junit</span>依赖<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>junit<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>junit<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span><span class="token number">4.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建Client类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1：创建HttpHost对象</span>
        <span class="token class-name">HttpHost</span> httpHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">"192.168.70.118"</span><span class="token punctuation">,</span><span class="token number">9200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2：创建RestClientBuilder对象</span>
        <span class="token class-name">RestClientBuilder</span> restClientBuilder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>httpHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建RestHighLevelClient对象</span>
        <span class="token class-name">RestHighLevelClient</span> restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>restClientBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restHighLevelClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestHighLevelClient</span> restHighLevelClient <span class="token operator">=</span> <span class="token class-name">EsClient</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-2-Java操作索引"><a href="#3-2-Java操作索引" class="headerlink" title="3.2 Java操作索引"></a>3.2 Java操作索引</h2><h3 id="1-创建索引"><a href="#1-创建索引" class="headerlink" title="1. 创建索引"></a>1. 创建索引</h3><ol>
<li>准备settings设置，如：分片数和副本数量</li>
<li>准备mappings设置，注意用startObject 和 endObject成对出现</li>
<li>将设置封装在一个request中，每个操作的request都不同</li>
<li>通过client对象连接es，提交请求。</li>
</ol>
<p>CreateIndexRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">//1.准备索引的settings设置</span>
<span class="token class-name">Settings<span class="token punctuation">.</span>Builder</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"number_of_shards"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"number_of_replicas"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2.准备索引结构，mappings</span>
<span class="token class-name">XContentBuilder</span> mappings <span class="token operator">=</span> <span class="token class-name">JsonXContent</span><span class="token punctuation">.</span><span class="token function">contentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"properties"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"keyword"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//3.将settings和mappings封装在一个request中</span>
<span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">settings</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">mapping</span><span class="token punctuation">(</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//4.通过Client对象连接es，创建索引</span>
<span class="token class-name">CreateIndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//5.输出测试</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"resp:"</span> <span class="token operator">+</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-判断索引是否存在"><a href="#2-判断索引是否存在" class="headerlink" title="2. 判断索引是否存在"></a>2. 判断索引是否存在</h3><p>GetIndexRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1；准备request对象</span>
        <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：通过client操作</span>
        <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3；输出结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-删除索引"><a href="#3-删除索引" class="headerlink" title="3. 删除索引"></a>3. 删除索引</h3><p>DeleteIndexRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1：准备request对象</span>
        <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：通过client对象执行</span>
        <span class="token class-name">AcknowledgedResponse</span> delete <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：获取返回结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>delete<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-3-Java添加文档"><a href="#3-3-Java添加文档" class="headerlink" title="3.3 Java添加文档"></a>3.3 Java添加文档</h2><ol>
<li>准备Json数据</li>
<li>准备一个request封装数据</li>
<li>使用Client对象执行</li>
</ol>
<p>Json数据创建一个类对象封装，从Json中去出数据创建对象实例后生成Json字符串</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>demos<span class="token punctuation">.</span>web<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonIgnore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Docx</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> author<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IndexRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3</span> <span class="token punctuation">{</span>
    <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token class-name">EsClient</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> index <span class="token operator">=</span> <span class="token string">"bk001"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">//1:准备json数据</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/Users/philcai/IdeaProjects/elasticSearch/src/text.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content<span class="token operator">=</span> <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">readFileToString</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> jsonObject<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Docx</span> docx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Docx</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>docx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//ObjectMapper objectMapper = new ObjectMapper();</span>
        <span class="token comment">//JsonNode jsonNode = objectMapper.readTree(new File("/Users/philcai/IdeaProjects/elasticSearch/src/text.json"));</span>
        <span class="token comment">//System.out.println(jsonNode);</span>
        <span class="token comment">//        2：准备一个request对象封装json</span>
        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//</span>
        <span class="token comment">//        //3：使用client对象执行</span>
        <span class="token class-name">IndexResponse</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-4-删除文档"><a href="#3-4-删除文档" class="headerlink" title="3.4 删除文档"></a>3.4 删除文档</h2><p>DeleteRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">//1:封装request对象</span>
<span class="token class-name">DeleteRequest</span> deleteRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"aEHMzY8BxgXGScnQGkd9"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2：创建client执行请求</span>
<span class="token class-name">DeleteResponse</span> delete <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>deleteRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3：返回测试结果</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>delete<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-5-修改文档"><a href="#3-5-修改文档" class="headerlink" title="3.5 修改文档"></a>3.5 修改文档</h2><p>UpdateRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">//1:创建一个map，指定需要修改的内容</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
doc<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"王冰冰"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2:创建一个request对象，封装数据</span>
<span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3：创建client对象执行</span>
<span class="token class-name">UpdateResponse</span> update <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//4:返回测试结果</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-6-Java批量操作文档"><a href="#3-6-Java批量操作文档" class="headerlink" title="3.6 Java批量操作文档"></a>3.6 Java批量操作文档</h2><p>BulkRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bulkCreateDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1：准备多个json数据</span>
    <span class="token class-name">Docx</span> docx1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Docx</span><span class="token punctuation">(</span><span class="token string">"这是第一个文档"</span><span class="token punctuation">,</span><span class="token string">"蔡鹏飞"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Docx</span> docx2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Docx</span><span class="token punctuation">(</span><span class="token string">"这是第二个文档"</span><span class="token punctuation">,</span><span class="token string">"王冰冰"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Docx</span> docx3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Docx</span><span class="token punctuation">(</span><span class="token string">"这是第三个文档"</span><span class="token punctuation">,</span><span class="token string">"流霞"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> json1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>docx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> json2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>docx2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> json3 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>docx3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2：创建Request对象，并将数据封装进去</span>
    <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"_doc"</span><span class="token punctuation">,</span>docx1<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json1<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"_doc"</span><span class="token punctuation">,</span>docx2<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json2<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"_doc"</span><span class="token punctuation">,</span>docx3<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json3<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3：创建client对象执行操作</span>
    <span class="token class-name">BulkResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4：输出结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DeleteRequest</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1：封装request对象</span>
    <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2：新建client对象执行</span>
    <span class="token class-name">BulkResponse</span> responses <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3：测试结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>responses<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-7-动态映射模板"><a href="#3-7-动态映射模板" class="headerlink" title="3.7 动态映射模板"></a>3.7 动态映射模板</h2><h3 id="3-7-1-基本语法"><a href="#3-7-1-基本语法" class="headerlink" title="3.7.1 基本语法"></a>3.7.1 基本语法</h3><p>默认映射规则不一定符合我们的需求，我们可以按照自己的方式来定义默认规则。这就需要用到动态模板了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 动态模板</span>
PUT hello3 
<span class="token punctuation">{</span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
          <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_max_word"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"dynamic_templates"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"strings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> 
            <span class="token string">"match_mapping_type"</span><span class="token builtin class-name">:</span> <span class="token string">"string"</span>,
            <span class="token string">"mapping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="4-Term-amp-terms查询"><a href="#4-Term-amp-terms查询" class="headerlink" title="4. Term&amp;terms查询"></a>4. Term&amp;terms查询</h1><h2 id="4-1-Term查询"><a href="#4-1-Term查询" class="headerlink" title="4.1. Term查询"></a>4.1. Term查询</h2><p>term查询是完全匹配，搜索之前不会对搜索的关键字进行分词，直接对关键字进行匹配查询。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">POST /bk001/_search
{
  "from": 0,
  "size": 5,
  "query": {
    "term": {
      "author": {
        "value": "软件测试项目评审表.docx"
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="01.png"></p>
<p>获取到的内容是由两个hits数组包含的，需要进行遍历访问查询到的每个元素。通过getHits()实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1:创建Request对象</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"软件测试项目评审表.docx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：执行查询，创建client对象提交request</span>
        <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：获取_source中的内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-2-Terms查询"><a href="#4-2-Terms查询" class="headerlink" title="4.2. Terms查询"></a>4.2. Terms查询</h2><p>term和terms的查询机制是一样的，不会对关键字进行分词，直接对关键字进行匹配。</p>
<p>terms针对的是一个字段包含多个值的时候使用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">terms: <span class="token keyword">where</span> pro <span class="token operator">=</span> <span class="token string">"Beijing"</span> <span class="token operator">or</span> pro <span class="token operator">=</span> <span class="token string">"Tianjin"</span> <span class="token operator">or</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># terms查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"from"</span>: <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"size"</span>: <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token string">"query"</span>: {
    <span class="token string">"terms"</span>: {
      <span class="token string">"author"</span>: <span class="token punctuation">[</span>
        <span class="token string">"软件测试项目评审表.docx"</span><span class="token punctuation">,</span>
        <span class="token string">"软件测试记录模板.docx"</span>
      <span class="token punctuation">]</span>
    }
  }
}
<span class="token variable">@Test</span>
    <span class="token keyword">public</span> void termsQuery<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1：创建request对象</span>
        SearchRequest searchRequest <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2：封装查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>termsQuery<span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"软件测试项目评审表.docx"</span><span class="token punctuation">,</span> <span class="token string">"软件测试记录模板.docx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRequest<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client，提交request</span>
        SearchResponse resp <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：输出查找到的内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-match查询"><a href="#4-3-match查询" class="headerlink" title="4.3 match查询"></a>4.3 match查询</h2><p>match属于高层查询，根据字段不同自动采用不同的查询方式。</p>
<ul>
<li>查询的是日期或者是数值的话，会将基于字符串查询的内容转换为日期或者数值对待</li>
<li> 如果查询的内容不可分词，则match不会对关键字进行分词</li>
<li>查询的内容可一分词，match会对关键字进行分词，后去词库中进行查询</li>
<li>match底层是多个term查询的结果</li>
</ul>
<h3 id="4-3-1-match-all查询"><a href="#4-3-1-match-all查询" class="headerlink" title="4.3.1. match_all查询"></a>4.3.1. match_all查询</h3><p>查询全部内容，</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"># match_all查询
<span class="token constant">POST</span> <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
<span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 <span class="token comment">//match_all</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1:创建request对象</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2：指定查询条件</span>
        <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ES默认只查询10条文件，需要通过size参数设置</span>
        builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象提交request</span>
        <span class="token class-name">SearchResponse</span> resp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4:输出结果</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-2-match查询"><a href="#4-3-2-match查询" class="headerlink" title="4.3.2. match查询"></a>4.3.2. match查询</h3><p>指定一个field条件实现查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># match查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"match"</span>: {
      <span class="token string">"content"</span>: <span class="token string">"技术文件"</span>
    }
  }
}
<span class="token keyword">public</span> void matchQuery<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>matchQuery<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"高峰"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：创建client对象提交request</span>
        SearchResponse resp <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：获取查询到的内容</span>

    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-3-布尔match查询"><a href="#4-3-3-布尔match查询" class="headerlink" title="4.3.3. 布尔match查询"></a>4.3.3. 布尔match查询</h3><p>基于field的内容，采用and 或者 or的方式连接</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># bool match查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"match"</span>: {
      <span class="token string">"content"</span>:{
        <span class="token string">"query"</span>: <span class="token string">"高峰 孟庆磊"</span><span class="token punctuation">,</span>
        <span class="token string">"operator"</span>: <span class="token string">"and"</span>
      }
    }
  }
}

POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"match"</span>: {
      <span class="token string">"content"</span>:{
        <span class="token string">"query"</span>: <span class="token string">"高峰 孟庆磊"</span><span class="token punctuation">,</span>
        <span class="token string">"operator"</span>: <span class="token string">"or"</span>
      }
    }
  }
}
<span class="token keyword">public</span> void boolMatch<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>matchQuery<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"高峰 孟庆磊"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>operator<span class="token punctuation">(</span>Operator<span class="token punctuation">.</span><span class="token operator">AND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：创建client对象提交request</span>
        SearchResponse resp <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：获取查询到的内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-4-multi-match查询"><a href="#4-3-4-multi-match查询" class="headerlink" title="4.3.4. multi_match查询"></a>4.3.4. multi_match查询</h3><p>match针对一个field做检索，    multi_match针对多个field进行检索，多个field对应一个text </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"multi_match"</span>: {
      <span class="token string">"query"</span>: <span class="token string">"测试"</span><span class="token punctuation">,</span>
      <span class="token string">"fields"</span>: <span class="token punctuation">[</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">]</span>
    }
  }
}
<span class="token comment">//multi_match</span>
    <span class="token keyword">public</span> void multiSearch<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>multiMatchQuery<span class="token punctuation">(</span><span class="token string">"测试"</span><span class="token punctuation">,</span> <span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：创建client对象提交request</span>
        SearchResponse resp <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：获取查询到的内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="5-其他查询"><a href="#5-其他查询" class="headerlink" title="5. 其他查询"></a>5. 其他查询</h1><h2 id="5-1-id查询"><a href="#5-1-id查询" class="headerlink" title="5.1. id查询"></a>5.1. id查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#id 查询</span>
GET <span class="token operator">/</span>bk001<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
<span class="token keyword">public</span> void findById<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建GetRequest</span>
        GetRequest request <span class="token operator">=</span> new GetRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：创建client执行查询结果</span>
        GetResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：输出结果</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>response<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-2-ids查询"><a href="#5-2-ids查询" class="headerlink" title="5.2. ids查询"></a>5.2. ids查询</h2><p>根据多个id查询，类似Mysql中的where id in (id1, id2, id3)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#ids 查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"ids"</span>: {
      <span class="token string">"values"</span>: <span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">]</span>
    }
  }
}
<span class="token keyword">public</span> void findByIds<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建search request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>idsQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>addIds<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象执行查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：获取查询到的结果</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-3-prefix查询"><a href="#5-3-prefix查询" class="headerlink" title="5.3. prefix查询"></a>5.3. prefix查询</h2><p>通过关键字指定一个field的前缀，从而查询到指定的内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#prefix查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"prefix"</span>: {
      <span class="token string">"author"</span>: {
        <span class="token string">"value"</span>: <span class="token string">"软件"</span>
      }
    }
  }
}
<span class="token keyword">public</span> void findByPrefix<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:构建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>prefixQuery<span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"软件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象，提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：返回查询内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-4-fuzzy查询"><a href="#5-4-fuzzy查询" class="headerlink" title="5.4. fuzzy查询"></a>5.4. fuzzy查询</h2><p>模糊查询，输入字符的大概，ES根据输入的内容匹配结果，查询结果不稳定</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#fuzzy 查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"fuzzy"</span>: {
      <span class="token string">"author"</span>: {
        <span class="token string">"value"</span>: <span class="token string">"软件测是"</span><span class="token punctuation">,</span>
        <span class="token string">"prefix_length"</span>: <span class="token number">3</span>   <span class="token comment">//前几个字符不可以出错</span>
      }
    }
  }
}
<span class="token keyword">public</span> void findByFuzzy<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:构建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>fuzzyQuery<span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"软件"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prefixLength<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象，提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：返回查询内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }

    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-5-wildcard查询"><a href="#5-5-wildcard查询" class="headerlink" title="5.5. wildcard查询"></a>5.5. wildcard查询</h2><p>通配查询，和Mysql中的like一样，可以在查询语句中指定通配字符*和占位符？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#wildcard 查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"wildcard"</span>: {
      <span class="token string">"author"</span>: {
        <span class="token string">"value"</span>: <span class="token string">"软件*"</span>
      }
    }
  }
}
<span class="token keyword">public</span> void findByWildCard <span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:构建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>wildcardQuery<span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"软件*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象，提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：返回查询内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }

    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-6-range查询"><a href="#5-6-range查询" class="headerlink" title="5.6. range查询"></a>5.6. range查询</h2><p>范围查询，只针对数值类型，对某一个field进行大于小于的范围查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#range查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"range"</span>: {
      <span class="token string">"author"</span>: {
        <span class="token string">"gte"</span>: <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">"lte"</span>: <span class="token number">20</span>
      }
    }
  }
}
<span class="token keyword">public</span> void findByRange<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:构建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>rangeQuery<span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>gt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象，提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：返回查询内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-7-regexp查询"><a href="#5-7-regexp查询" class="headerlink" title="5.7. regexp查询"></a>5.7. regexp查询</h2><p>正则查询，通过正则表达式匹配内容。</p>
<p>prefix, wildcard，regexp查询效率较低</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#regexp查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"regexp"</span>: {
      <span class="token string">"phone"</span>: <span class="token string">"180[0-9]{8}"</span>   <span class="token comment">//180开头的手机号</span>
    }
  }
}
<span class="token keyword">public</span> void findByRegexp<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:构建request对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>regexpQuery<span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span><span class="token string">"139[0-9]{8}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：创建client对象，提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：返回查询内容</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-8-深分页Scroll"><a href="#5-8-深分页Scroll" class="headerlink" title="5.8. 深分页Scroll"></a>5.8. 深分页Scroll</h2><p>ES对from+size 是有限制的，from和size二者之和不能超过1w</p>
<p>from + size原理：</p>
<ul>
<li>ES的数据查询方式，第一步先将用户指定的关键字分词</li>
<li>将分词后的词语去匹配词库得到多个文章的id</li>
<li>去各个分片中拉取指定的数据</li>
<li>将拉取的数据按照score排序</li>
<li>根据from的值将查询到的值舍弃一部分</li>
<li>返回结果</li>
</ul>
<p>scroll + size原理</p>
<ul>
<li>ES的数据查询方式，第一步先将用户指定的关键字分词</li>
<li>将分词后的词语去匹配词库得到多个文章的id</li>
<li>将文档的id存放在ES的上下文中</li>
<li>根据指定的size检索指定的数据，拿完文档数据的id，会从上下文中删除</li>
<li>需要下一页时，直接去上下文中寻找后续内容</li>
<li>循环第四第五步</li>
</ul>
<p><strong>Scroll不适合实时查询</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#执行scroll查询，返回第一页数据，并将文档id存放在ES上下文中，设置上下文生存时间</span>
<span class="token comment">#scroll查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search?scroll<span class="token operator">=</span><span class="token number">1</span>m
{
  <span class="token string">"query"</span>: {
    <span class="token string">"match_all"</span>: {}
  }<span class="token punctuation">,</span>
  <span class="token string">"size"</span>: <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token string">"sort"</span>: <span class="token punctuation">[</span>
    {
      <span class="token string">"fee"</span>: {
        <span class="token string">"order"</span>: <span class="token string">"desc"</span>
      }
    }
  <span class="token punctuation">]</span>
}

<span class="token comment">#紧接着查寻第二页</span>
POST <span class="token operator">/</span>_search<span class="token operator">/</span>scroll
{
  <span class="token string">"scroll_id"</span> : <span class="token string">"&lt;根据第一步得到的scroll_id码&gt;"</span><span class="token punctuation">,</span>
  <span class="token string">"scroll"</span> : <span class="token string">"1m"</span>
}

<span class="token comment"># 删除scroll上下文的数据</span>
<span class="token keyword">DELETE</span> <span class="token operator">/</span>_search<span class="token operator">/</span>scroll<span class="token operator">/</span>scroll_id
<span class="token keyword">public</span> void scrollQuery<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建Search request</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定scroll信息</span>
        request<span class="token punctuation">.</span>scroll<span class="token punctuation">(</span>TimeValue<span class="token punctuation">.</span>timeValueMinutes<span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token string">"fee"</span><span class="token punctuation">,</span> SortOrder<span class="token punctuation">.</span><span class="token keyword">ASC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>matchAllQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：获取返回结果，scroll_id和source内容</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String scrollId <span class="token operator">=</span> response<span class="token punctuation">.</span>getScrollId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">"-------分割线--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>{
        <span class="token comment">//5：循环---创建search scroll request对象</span>
            SearchScrollRequest scrollRequest <span class="token operator">=</span> new SearchScrollRequest<span class="token punctuation">(</span>scrollId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6：指定scroll_id</span>
            scrollRequest<span class="token punctuation">.</span>scroll<span class="token punctuation">(</span>TimeValue<span class="token punctuation">.</span>timeValueMinutes<span class="token punctuation">(</span><span class="token number">1</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7：执行查询返回结果</span>
            SearchResponse scroll <span class="token operator">=</span> client<span class="token punctuation">.</span>scroll<span class="token punctuation">(</span>scrollRequest<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//8：判断是否查询到了数据，输出or停止---退出循环</span>
            SearchHit<span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> scroll<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>searchHits<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> searchHits <span class="token operator">!=</span> <span class="token boolean">null</span><span class="token punctuation">)</span> {
                System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">"-----------下一页------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span>SearchHit hit : searchHits<span class="token punctuation">)</span>{
                    System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                }
            }<span class="token keyword">else</span> {
                System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">"----------结束-----------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            }
        }

        <span class="token comment">//9：创建clear scroll request对象</span>
        ClearScrollRequest clearScrollRequest <span class="token operator">=</span> new ClearScrollRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//10：指定scroll_id</span>
        clearScrollRequest<span class="token punctuation">.</span>addScrollId<span class="token punctuation">(</span>scrollId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//11:删除scroll_id</span>
        ClearScrollResponse clearScrollResponse <span class="token operator">=</span> client<span class="token punctuation">.</span>clearScroll<span class="token punctuation">(</span>clearScrollRequest<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//12:删除结果</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span><span class="token string">"删除scrollId"</span> <span class="token operator">+</span> clearScrollResponse<span class="token punctuation">.</span>isSucceeded<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-9-delete-by-query"><a href="#5-9-delete-by-query" class="headerlink" title="5.9. delete-by-query"></a>5.9. delete-by-query</h2><p>根据term，match等查询方式删除大量的文档</p>
<p>如果需要删除的内容是大部分数据，不推荐，推荐创建一个全新的索引，将保留的文档内容添加到全新的索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># delete-by-query </span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_delete_by_query
{
  <span class="token string">"query"</span>:{
    <span class="token string">"match_all"</span>: {
      
    }
  }
}
<span class="token keyword">public</span> void deleteByQuery<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建deletebyquery对象</span>
        DeleteByQueryRequest request <span class="token operator">=</span> new DeleteByQueryRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定检索条件 与searchrequest指定条件是不同的</span>
        request<span class="token punctuation">.</span>setQuery<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>matchAllQuery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：执行删除</span>
        BulkByScrollResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>deleteByQuery<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4：返回删除结果</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>response<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-10-复合查询"><a href="#5-10-复合查询" class="headerlink" title="5.10. 复合查询"></a>5.10. 复合查询</h2><h3 id="5-10-1-bool查询"><a href="#5-10-1-bool查询" class="headerlink" title="5.10.1. bool查询"></a>5.10.1. bool查询</h3><p>复合过滤器，将多个查询条件，以一定的逻辑组合在一起</p>
<ul>
<li>must：所有的条件，相当于and的意思</li>
<li>must_not：对其条件全部都不匹配，相当于not</li>
<li>should：相当于or的意思</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#bool查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"bool"</span>: {
      <span class="token string">"should"</span>: <span class="token punctuation">[</span>
        {
          <span class="token string">"term"</span>: {
            <span class="token string">"author"</span>: {
              <span class="token string">"value"</span>: <span class="token string">"cpf"</span>
            }
          }
        }<span class="token punctuation">,</span>
        {
          <span class="token string">"term"</span>: {
            <span class="token string">"author"</span>: {
              <span class="token string">"value"</span>: <span class="token string">"sys"</span>
            }
          }
        }
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"must_not"</span>: <span class="token punctuation">[</span>
        {
          <span class="token string">"term"</span>: {
            <span class="token string">"content"</span>: {
              <span class="token string">"value"</span>: <span class="token string">"开发"</span>
            }
          }
        }
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"must"</span>: <span class="token punctuation">[</span>
        {
          <span class="token string">"match"</span>: {
            <span class="token string">"content"</span>: <span class="token string">"阴阳"</span>
          }
        }<span class="token punctuation">,</span>
        {
          <span class="token string">"match"</span>: {
            <span class="token string">"content"</span>: <span class="token string">"太极"</span>
          }
        }
      <span class="token punctuation">]</span>
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1:创建searchrequest对象</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoolQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            boolQuery<span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"cpf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"sys"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">mustNot</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span><span class="token string">"开发"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span><span class="token string">"测试"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3：提交查询</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4：输出结果</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-11-boosting查询"><a href="#5-11-boosting查询" class="headerlink" title="5.11. boosting查询"></a>5.11. boosting查询</h2><p>boosting查询可以帮助我们影响查询后的score</p>
<ul>
<li>positive：只有匹配上positive的内容，才会被放到返回的结果集中</li>
<li>negative：如果pos和neg都匹配上了，则降低文档的score</li>
<li>negative_boost：指定系数，必须小于1</li>
</ul>
<p>分数如何计算</p>
<ul>
<li>关键字出现的频次越高，分数越高</li>
<li>指定的文档内容越短，分数就越高</li>
<li>在搜索时，通过关键字的分词，对分词的内容匹配的越多，分数越高</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">#boosting查询
POST /bk001/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"boosting"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"positive"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"测试报告"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"negative"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"content"</span><span class="token operator">:</span><span class="token string">"高峰"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"negative_boost"</span><span class="token operator">:</span> <span class="token number">0.2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
public void boostingQuery() throws IOException <span class="token punctuation">{</span>
        <span class="token comment">//1:创建searchrequest对象</span>
        SearchRequest request = new SearchRequest(index);

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder = new SearchSourceBuilder();
        BoostingQueryBuilder boost = QueryBuilders.boostingQuery(
                QueryBuilders.matchQuery(<span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"测试报告"</span>)<span class="token punctuation">,</span>
                QueryBuilders.matchQuery(<span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"高峰"</span>)
                ).negativeBoost(<span class="token number">0</span>.5f);

        builder.query(boost);
        request.source(builder);

        <span class="token comment">//3：提交查询</span>
        SearchResponse response = client.search(request<span class="token punctuation">,</span> RequestOptions.DEFAULT);
        <span class="token comment">//4：输出结果</span>
        for (SearchHit hit <span class="token operator">:</span> response.getHits().getHits()) <span class="token punctuation">{</span>
            System.out.println(hit.getSourceAsMap());
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-12-filter查询"><a href="#5-12-filter查询" class="headerlink" title="5.12. filter查询"></a>5.12. filter查询</h2><p><strong>query：</strong>根据条件，计算文档的匹配度得到一个分数，并根据分数进行排序，不会做缓存</p>
<p><strong>filter</strong>：根据条件查询但是不计算文档的分数，且filter会对经常被过滤的数据进行缓存</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#filter 查询</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"bool"</span>: {
      <span class="token string">"filter"</span>: <span class="token punctuation">[</span>
        {
          <span class="token string">"term"</span>: {
            <span class="token string">"content"</span>: <span class="token string">"测试报告"</span>
          }
        }
      <span class="token punctuation">]</span>
    }
  }
}
<span class="token keyword">public</span> void filterQuery<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建searchrequest对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BoolQueryBuilder boolQueryBuilder <span class="token operator">=</span> new BoolQueryBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>termQuery<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span><span class="token string">"测试报告"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4：输出结果</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getSourceAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /bk001/_search
<span class="token punctuation">{</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">"agg_type"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"属性"</span><span class="token operator">:</span><span class="token string">"值"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="7-聚合查询"><a href="#7-聚合查询" class="headerlink" title="7. 聚合查询"></a>7. 聚合查询</h1><h2 id="7-1-去重计数查询"><a href="#7-1-去重计数查询" class="headerlink" title="7.1. 去重计数查询"></a>7.1. 去重计数查询</h2><p>Cardinality，第一步先将返回的文档中的指定的field进行去重，统计有多少条。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">#聚合查询
POST /bk001/_search
<span class="token punctuation">{</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"agg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"cardinality"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"author"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
public void cadinality() throws IOException <span class="token punctuation">{</span>
        <span class="token comment">//1:创建request</span>
        SearchRequest request = new SearchRequest(index);

        <span class="token comment">//2：指定查询方式</span>
        SearchSourceBuilder builder = new SearchSourceBuilder();
        builder.aggregation(AggregationBuilders.cardinality(<span class="token string">"agg"</span>).field(<span class="token string">"author"</span>));

        request.source(builder);

        <span class="token comment">//3：执行查询</span>
        SearchResponse response = client.search(request<span class="token punctuation">,</span> RequestOptions.DEFAULT);

        <span class="token comment">//4：返回查询结果</span>
        <span class="token comment">//向下转型，cardinality继承aggregation接口，要获取value值需要将agg转为car，实现方法</span>
        Cardinality agg = response.getAggregations().get(<span class="token string">"agg"</span>);
        long value = agg.getValue();
        System.out.println(value);
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-2-范围统计"><a href="#7-2-范围统计" class="headerlink" title="7.2. 范围统计"></a>7.2. 范围统计</h2><p>统计一定范围内出现的文档个数</p>
<p>范围统计可以针对数值 range、时间类型date_range、IP类型ip_range做相应的统计。</p>
<p><strong>数值统计</strong></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">#数值范围统计
POST /bk001/_search
<span class="token punctuation">{</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"agg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"fee"</span><span class="token punctuation">,</span>
        <span class="token property">"ranges"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            #to 不带等于<span class="token punctuation">,</span>表示从最小到<span class="token number">5</span>
            <span class="token property">"to"</span><span class="token operator">:</span> <span class="token number">5</span>
            
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            #from 带等于，表示从<span class="token number">50</span>开始
            <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
            <span class="token property">"to"</span><span class="token operator">:</span> <span class="token number">100</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">100</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>时间统计</strong></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">#时间范围统计
POST /bk001/_search
<span class="token punctuation">{</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"agg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"date_range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"createDate"</span><span class="token punctuation">,</span>
        <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">,</span> 
        <span class="token property">"ranges"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">"to"</span><span class="token operator">:</span> <span class="token string">"2000-01-01"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"from"</span><span class="token operator">:</span><span class="token string">"2001-02-02"</span>
          <span class="token punctuation">}</span>
          
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>IP统计方式</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#<span class="token constant">IP</span>统计
<span class="token constant">POST</span> <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"agg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"ip_range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"IP"</span><span class="token punctuation">,</span>
        <span class="token string">"ranges"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">"from"</span><span class="token operator">:</span> <span class="token string">"10.0.0.5"</span><span class="token punctuation">,</span>
            <span class="token string">"to"</span><span class="token operator">:</span> <span class="token string">"10.0.0.10"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-3-统计聚合查询"><a href="#7-3-统计聚合查询" class="headerlink" title="7.3. 统计聚合查询"></a>7.3. 统计聚合查询</h2><p>可以查询一个field的最大值，最小值，平均值，平方和等</p>
<p>extended_stats</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">#统计聚合查询
POST /bk001/_search
<span class="token punctuation">{</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"agg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"extended_stats"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"fee"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
public void extendedStats() throws IOException <span class="token punctuation">{</span>
        <span class="token comment">//1:创建request</span>
        SearchRequest request = new SearchRequest(index);

        <span class="token comment">//2：指定查询方式</span>
        SearchSourceBuilder builder = new SearchSourceBuilder();
        builder.aggregation(AggregationBuilders.extendedStats(<span class="token string">"agg"</span>).field(<span class="token string">"fee"</span>));
        request.source(builder);

        <span class="token comment">//3：执行查询</span>

        SearchResponse response = client.search(request<span class="token punctuation">,</span> RequestOptions.DEFAULT);

        <span class="token comment">//4：返回查询结果</span>
        ExtendedStats agg = response.getAggregations().get(<span class="token string">"agg"</span>);
        double max = agg.getMax();
        double min = agg.getMin();
        System.out.println(<span class="token string">"Max:"</span> + max + <span class="token string">"Min:"</span> + min);
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="8-搜索结果高亮显示"><a href="#8-搜索结果高亮显示" class="headerlink" title="8. 搜索结果高亮显示"></a>8. 搜索结果高亮显示</h1><p>以一定的特殊样式显示搜索的关键词</p>
<p>高亮展示的内容本身是文档的一个field，单独将field以highlight的形式返回</p>
<p>ES提供一个highlights属性，和query是同级别的</p>
<ul>
<li>fragment_size：指定高亮数据展示多少个字符，默认100个</li>
<li>pre_tags：指定前缀标签<font color="red"></font></li><font color="red">
</font><li><font color="red">post_tags：指定后缀标签</font></li>
<li>fields：指定哪几个field返回</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#highlight</span>
POST <span class="token operator">/</span>bk001<span class="token operator">/</span>_search
{
  <span class="token string">"query"</span>: {
    <span class="token string">"match"</span>: {
      <span class="token string">"content"</span>: <span class="token string">"软件测试"</span>
    }
  }<span class="token punctuation">,</span>
  <span class="token string">"highlight"</span>: {
    <span class="token string">"fields"</span>: {
      <span class="token string">"content"</span>: {}<span class="token punctuation">,</span>
    }<span class="token punctuation">,</span>
    <span class="token string">"pre_tags"</span>: <span class="token string">"&lt;font color='red'&gt;"</span><span class="token punctuation">,</span>
    <span class="token string">"post_tags"</span>: <span class="token string">"&lt;/font&gt;"</span><span class="token punctuation">,</span>
    <span class="token string">"fragment_size"</span>: <span class="token string">"5"</span>
  }
}
<span class="token keyword">public</span> void highLightQuery<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException {
        <span class="token comment">//1:创建searchrequest对象</span>
        SearchRequest request <span class="token operator">=</span> new SearchRequest<span class="token punctuation">(</span><span class="token keyword">index</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2：指定查询条件</span>
        SearchSourceBuilder builder <span class="token operator">=</span> new SearchSourceBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>query<span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span>matchQuery<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span><span class="token string">"软件测试"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3:指定高亮</span>
        HighlightBuilder highlightBuilder <span class="token operator">=</span> new HighlightBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>preTags<span class="token punctuation">(</span><span class="token string">"&lt;font color='red'&gt;"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>postTags<span class="token punctuation">(</span><span class="token string">"&lt;/font&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span>highlighter<span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>source<span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3：提交查询</span>
        SearchResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">,</span> RequestOptions<span class="token punctuation">.</span><span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4：获取高亮结果</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SearchHit hit : response<span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> {
            System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span>println<span class="token punctuation">(</span>hit<span class="token punctuation">.</span>getHighlightFields<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Elasticsearch/">
                                    <span class="chip bg-color">Elasticsearch</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2024/07/12/elasticsearch-bi-ji/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Elasticsearch笔记">
                        
                        <span class="card-title">Elasticsearch笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-07-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Elasticsearch/" class="post-category">
                                    Elasticsearch
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Elasticsearch/">
                        <span class="chip bg-color">Elasticsearch</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/03/16/java-ji-chu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Java基础">
                        
                        <span class="card-title">Java基础</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-03-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" class="post-category">
                                    后端开发
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <a href="/about" target="_blank">Phil Cai</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">75.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pfcai" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1270064697@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1270064697" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1270064697" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
